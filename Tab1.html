<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>Tab1_Heatmap</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Do+Hyeon&display=swap"
      rel="stylesheet"
    />
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
      body {
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding: 20px;
        font-family: "Do Hyeon", sans-serif;
        position: relative;
      }
      #heatmap-container {
        flex: 1;
        display: flex;
        justify-content: center;
        margin-left: -150px;
      }
      .cell {
        stroke: #fff;
      }
      .axis-label {
        font-size: 12px;
        text-anchor: end;
        fill: #333;
      }
      .highlight {
        fill: red !important;
        font-size: 16px;
        font-weight: bold;
      }
      .title {
        font-size: 40px;
        text-anchor: middle;
        fill: #333;
        font-weight: bold;
      }
      .tooltip {
        position: absolute;
        text-align: center;
        width: auto;
        height: auto;
        padding: 5px;
        font: 12px "Do Hyeon", sans-serif;
        background: rgba(0, 0, 0, 0.7);
        color: white;
        border: 0px;
        border-radius: 8px;
        pointer-events: none;
      }
      #details {
        position: absolute;
        top: 45%;
        transform: translateY(-50%);
        right: 11%;
        width: 12%;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 8px;
        background-color: #f9f9f9;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        font-size: 18px;
      }
      #details h3 {
        margin-top: 0;
        font-size: 24px;
      }
    </style>
  </head>
  <body>
    <div id="heatmap-container">
      <div id="heatmap"></div>
    </div>
    <div id="details" class="details">
      <h3>상세 정보</h3>
      <p>상세 정보를 보려면 셀을 클릭하세요</p>
    </div>
    <script>
      const margin = { top: 50, right: 20, bottom: 150, left: 150 };
      const width = (window.innerWidth - margin.left - margin.right) / 2;
      const height = width;

      // 한글 번역 맵
      const translationMap = {
        GoldPerMin: "분당 골드",
        CSPerMin: "분당 CS",
        ExperienceDiff: "경험치 차이",
        GoldDiff: "골드 차이",
        TotalJungleMinionsKilled: "총 정글 몬스터 처치 수",
        TotalMinionsKilled: "총 CS",
        TotalExperience: "총 경험치",
        AvgLevel: "평균 레벨",
        TotalGold: "총 골드",
        TowersDestroyed: "파괴된 포탑 수",
        Heralds: "전령 처치 수",
        Dragons: "용 처치 수",
        EliteMonsters: "엘리트 몬스터 처치 수",
        Assists: "어시스트",
        Deaths: "데스",
        Kills: "킬",
        FirstBlood: "퍼스트 블러드",
        WardsDestroyed: "파괴된 와드 수",
        WardsPlaced: "설치한 와드 수",
      };

      const svg = d3
        .select("#heatmap")
        .append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform", `translate(${margin.left},${margin.top})`);

      const tooltip = d3
        .select("body")
        .append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);

      let selectedCell = null;

      d3.csv("data2.csv").then((data) => {
        const attributes = Object.keys(data[0]).filter(
          (key) => key !== "gameId"
        );

        data.forEach((d) => {
          attributes.forEach((attr) => {
            d[attr] = +d[attr];
          });
        });

        // 정규화 함수 (LLM Generated)
        function normalize(data, attribute) {
          const max = d3.max(data, (d) => d[attribute]);
          const min = d3.min(data, (d) => d[attribute]);
          return data.map((d) => ({
            ...d,
            [attribute]: (d[attribute] - min) / (max - min),
            [`${attribute}_actual`]: d[attribute],
          }));
        }

        attributes.forEach((attr) => {
          data = normalize(data, attr);
        });

        const correlationMatrix = calculateCorrelationMatrix(data, attributes);

        const colorScale = d3
          .scaleSequential(d3.interpolateRdBu)
          .domain([-1, 1]);

        const x = d3
          .scaleBand()
          .range([0, width])
          .domain(attributes)
          .padding(0.01);
        const xAxis = svg
          .append("g")
          .attr("transform", `translate(0, ${height})`)
          .call(d3.axisBottom(x))
          .selectAll("text")
          .attr("class", "axis-label x-label")
          .attr("transform", "rotate(-45)")
          .style("text-anchor", "end");

        const y = d3
          .scaleBand()
          .range([height, 0])
          .domain(attributes)
          .padding(0.01);
        const yAxis = svg
          .append("g")
          .call(d3.axisLeft(y))
          .selectAll("text")
          .attr("class", "axis-label y-label");

        svg
          .selectAll()
          .data(correlationMatrix)
          .enter()
          .append("rect")
          .attr("x", (d) => x(d.attribute1))
          .attr("y", (d) => y(d.attribute2))
          .attr("width", x.bandwidth())
          .attr("height", y.bandwidth())
          .attr("class", "cell")
          .attr("rx", 8)
          .attr("ry", 8)
          .style("fill", (d) => colorScale(d.value))
          .style("stroke-width", 1)
          .style("stroke", "none")
          .on("mouseover", function (event, d) {
            tooltip.transition().duration(200).style("opacity", 0.9);
            tooltip
              .html(`Value: ${d.value.toFixed(2)}`)
              .style("left", event.pageX + 5 + "px")
              .style("top", event.pageY - 28 + "px");
            d3.select(this)
              .raise()
              .style("stroke", "black")
              .style("stroke-width", 4);
          })
          .on("mouseout", function (event, d) {
            tooltip.transition().duration(500).style("opacity", 0);
            d3.select(this).style("stroke", "none").style("stroke-width", 1);
          })

          .on("click", function (event, d) {
            if (selectedCell) {
              d3.selectAll(".axis-label").classed("highlight", false);
            }
            const isSameCell = selectedCell === this;
            selectedCell = isSameCell ? null : this;

            if (selectedCell) {
              d3.selectAll(".x-label")
                .filter(function () {
                  return d3.select(this).text() === d.attribute1;
                })
                .classed("highlight", true);

              d3.selectAll(".y-label")
                .filter(function () {
                  return d3.select(this).text() === d.attribute2;
                })
                .classed("highlight", true);
            }
            showDetails(d, data);
          });

        svg
          .append("text")
          .attr("class", "title")
          .attr("x", width / 2)
          .attr("y", -20)
          .text("승리에 영향을 미치는 지표들의 상관관계");
      });

      // 상관계수 계산 함수 (LLM Generated)
      function calculateCorrelationMatrix(data, attributes) {
        const n = attributes.length;
        const matrix = [];

        for (let i = 0; i < n; i++) {
          for (let j = 0; j < n; j++) {
            const attribute1 = attributes[i];
            const attribute2 = attributes[j];
            const value = calculateCorrelation(data, attribute1, attribute2);
            matrix.push({ attribute1, attribute2, value });
          }
        }
        return matrix;
      }

      function calculateCorrelation(data, attr1, attr2) {
        const mean1 = d3.mean(data, (d) => d[attr1]);
        const mean2 = d3.mean(data, (d) => d[attr2]);
        const numerator = d3.sum(
          data,
          (d) => (d[attr1] - mean1) * (d[attr2] - mean2)
        );
        const denominator = Math.sqrt(
          d3.sum(data, (d) => Math.pow(d[attr1] - mean1, 2)) *
            d3.sum(data, (d) => Math.pow(d[attr2] - mean2, 2))
        );
        return numerator / denominator;
      }

      function showDetails(d, data) {
        const detailsDiv = document.getElementById("details");
        const xActual = data.find((item) => item[d.attribute1 + "_actual"]);
        const yActual = data.find((item) => item[d.attribute2 + "_actual"]);
        detailsDiv.innerHTML = `
          <h3>상세 정보</h3>
          <p><strong>X축:</strong> ${
            translationMap[d.attribute1] || d.attribute1
          }</p>
          <p><strong>X축 실제 값:</strong> ${
            xActual[d.attribute1 + "_actual"]
          }</p>
          <p><strong>Y축:</strong> ${
            translationMap[d.attribute2] || d.attribute2
          }</p>
          <p><strong>Y축 실제 값:</strong> ${
            yActual[d.attribute2 + "_actual"]
          }</p>
          <p><strong>상관 계수:</strong> ${d.value.toFixed(2)}</p>
        `;
      }
    </script>
  </body>
</html>
